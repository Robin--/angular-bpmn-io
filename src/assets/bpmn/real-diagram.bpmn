<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="1.14.0">
  <bpmn:message id="CrmNotificationPotentialCounterpartToArchive" name="PotentialCounterpart.ToArchive" />
  <bpmn:message id="CrmNotificationPotentialCounterpartToRepeat" name="PotentialCounterpart.ToRepeat" />
  <bpmn:message id="CrmTelephonyIncomingCall" name="PotentialCounterpart.IncomingCall" />
  <bpmn:collaboration id="CrmBP_1_1">
    <bpmn:documentation>Первичная обработка потенциального контрагента
=========================================

В этом процессе участвуют сотрудники двух ролей:
- специалист коммерческого отдела
- специалист call-центра</bpmn:documentation>
    <bpmn:participant id="crmPotentialCounterpartDraft" name="Первичная обработка потенциального контрагента" processRef="Crm.PotentialCounterpart.Draft" />
  </bpmn:collaboration>
  <bpmn:process id="Crm.PotentialCounterpart.Draft" name="Первичная обработка потенциального контрагента" isExecutable="true" camunda:versionTag="v1.0">
    <bpmn:documentation>Тут попробовали описать процесс</bpmn:documentation>
    <bpmn:laneSet>
      <bpmn:lane id="employeeCallCenter" name="Сотрудник call-центра">
        <bpmn:flowNodeRef>waitToApprove</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>phoneCall</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>targetDecision</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>endToRepeat</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>endNotTargeted</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>interest</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>sendProposal</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>recallDecision</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>recallTimer</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="employeeCommerce" name="Сотрудник коммерческого отдела">
        <bpmn:flowNodeRef>processStart</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>cardCreation</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>callNextProcess</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>end</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>incomingCall</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>
    <bpmn:sequenceFlow id="waining" sourceRef="sendProposal" targetRef="waitToApprove" />
    <bpmn:sequenceFlow id="interestNo" name="Нет" sourceRef="interest" targetRef="targetDecision">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${JSON(entity).prop("interest").boolValue() != true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="recall" name="Перезвонить" sourceRef="recallTimer" targetRef="phoneCall" />
    <bpmn:sequenceFlow id="noRecallNeeded" name="Нет" sourceRef="recallDecision" targetRef="interest">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${needToRecall}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="callResult" name="Результат звонка&#10;" sourceRef="phoneCall" targetRef="recallDecision" />
    <bpmn:sequenceFlow id="toProcessing" sourceRef="waitToApprove" targetRef="callNextProcess" />
    <bpmn:startEvent id="processStart" name="Начало">
      <bpmn:outgoing>begin</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="begin" sourceRef="processStart" targetRef="cardCreation" />
    <bpmn:intermediateCatchEvent id="waitToApprove" name="Время на ожидание ознакомления с КП&#10;">
      <bpmn:incoming>waining</bpmn:incoming>
      <bpmn:outgoing>toProcessing</bpmn:outgoing>
      <bpmn:timerEventDefinition>
        <bpmn:timeDate xsi:type="bpmn:tFormalExpression">${processContinueTime}</bpmn:timeDate>
      </bpmn:timerEventDefinition>
    </bpmn:intermediateCatchEvent>
    <bpmn:userTask id="cardCreation" name="Создание потенциального контрагента&#10;" camunda:formKey="PossibleCounterpart" camunda:candidateGroups="commerceDept">
      <bpmn:extensionElements>
        <camunda:formData>
          <camunda:formField id="actions" label="Команды" type="string" defaultValue="[{ &#34;name&#34;: &#34;save&#34;, &#34;label&#34;: &#34;Сохранить&#34; },{ &#34;name&#34;: &#34;complete&#34;, &#34;label&#34;: &#34;Сохранить и завершить&#34; }]" />
        </camunda:formData>
      </bpmn:extensionElements>
      <bpmn:incoming>begin</bpmn:incoming>
      <bpmn:outgoing>callNeeded</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:userTask id="phoneCall" name="Позвонить потенциальному контрагенту&#10;" camunda:formKey="PossibleCounterpart" camunda:candidateGroups="callCenterDept">
      <bpmn:extensionElements>
        <camunda:formData>
          <camunda:formField id="actions" label="Команды" type="string" defaultValue="[{&#34;name&#34;: &#34;completeCallResult&#34;, &#34;label&#34;: &#34;Записать итог звонка&#34;}]" />
        </camunda:formData>
      </bpmn:extensionElements>
      <bpmn:incoming>callNeeded</bpmn:incoming>
      <bpmn:incoming>recall</bpmn:incoming>
      <bpmn:outgoing>callResult</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="callNeeded" name="На обзвон" sourceRef="cardCreation" targetRef="phoneCall" />
    <bpmn:callActivity id="callNextProcess" name="БП 1.2 Проработка потенциального контрагента&#10;" calledElement="Crm.PotentialCounterpart.Processing">
      <bpmn:extensionElements>
        <camunda:in businessKey="#{execution.processBusinessKey}" />
        <camunda:in variables="all" />
        <camunda:out variables="all" />
      </bpmn:extensionElements>
      <bpmn:incoming>toProcessing</bpmn:incoming>
      <bpmn:incoming>callNetxStep</bpmn:incoming>
      <bpmn:outgoing>ending</bpmn:outgoing>
    </bpmn:callActivity>
    <bpmn:endEvent id="end" name="Выход">
      <bpmn:incoming>ending</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="ending" sourceRef="callNextProcess" targetRef="end" />
    <bpmn:exclusiveGateway id="targetDecision" name="Контрагент целевой?&#10;">
      <bpmn:incoming>interestNo</bpmn:incoming>
      <bpmn:outgoing>targetedNo</bpmn:outgoing>
      <bpmn:outgoing>targetedYes</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:endEvent id="endToRepeat" name="Временно нецелевой (в повтор)">
      <bpmn:incoming>targetedYes</bpmn:incoming>
      <bpmn:messageEventDefinition messageRef="CrmNotificationPotentialCounterpartToRepeat" camunda:type="external" camunda:topic="Crm.ExternalTask.Notification" />
    </bpmn:endEvent>
    <bpmn:endEvent id="endNotTargeted" name="Нецелевой (в архив)">
      <bpmn:incoming>targetedNo</bpmn:incoming>
      <bpmn:messageEventDefinition messageRef="CrmNotificationPotentialCounterpartToArchive" camunda:type="external" camunda:topic="Crm.ExternalTask.Notification" />
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="targetedNo" name="Нет" sourceRef="targetDecision" targetRef="endNotTargeted">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${JSON(entity).prop("status").numberValue() == 3}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="targetedYes" name="Да" sourceRef="targetDecision" targetRef="endToRepeat">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${JSON(entity).prop("status").numberValue() == 2}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="interest" name="Заинтересованность есть?&#10;">
      <bpmn:incoming>noRecallNeeded</bpmn:incoming>
      <bpmn:outgoing>interestNo</bpmn:outgoing>
      <bpmn:outgoing>interestYes</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sendTask id="sendProposal" name="Направить коммерческое предложение&#10;" camunda:type="external" camunda:topic="Crm.ExternalTask.SendEmail.CommercialProposal">
      <bpmn:incoming>interestYes</bpmn:incoming>
      <bpmn:outgoing>waining</bpmn:outgoing>
    </bpmn:sendTask>
    <bpmn:sequenceFlow id="interestYes" name="Да" sourceRef="interest" targetRef="sendProposal">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${JSON(entity).prop("interest").boolValue() == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="recallDecision" name="Нужен повторный звонок?&#10;">
      <bpmn:incoming>callResult</bpmn:incoming>
      <bpmn:outgoing>noRecallNeeded</bpmn:outgoing>
      <bpmn:outgoing>recallNeeded</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:intermediateCatchEvent id="recallTimer" name="Повторный звонок">
      <bpmn:incoming>recallNeeded</bpmn:incoming>
      <bpmn:outgoing>recall</bpmn:outgoing>
      <bpmn:timerEventDefinition>
        <bpmn:timeDate xsi:type="bpmn:tFormalExpression">${recallTime}</bpmn:timeDate>
      </bpmn:timerEventDefinition>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="recallNeeded" name="Да" sourceRef="recallDecision" targetRef="recallTimer">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${!needToRecall}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="callNetxStep" name="Запуск подпроцесса" sourceRef="incomingCall" targetRef="callNextProcess" />
    <bpmn:startEvent id="incomingCall" name="Входящий звонок от ПК" camunda:initiator="EXTERNAL">
      <bpmn:extensionElements>
        <camunda:executionListener expression="${incomingCall = true}" event="start" />
      </bpmn:extensionElements>
      <bpmn:outgoing>callNetxStep</bpmn:outgoing>
      <bpmn:messageEventDefinition messageRef="CrmTelephonyIncomingCall" />
    </bpmn:startEvent>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="CrmBP_1_1">
      <bpmndi:BPMNShape id="Participant_1gdzzg2_di" bpmnElement="crmPotentialCounterpartDraft">
        <dc:Bounds x="204" y="86" width="1008" height="641" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_0iwccls_di" bpmnElement="employeeCommerce">
        <dc:Bounds x="234" y="86" width="978" height="211" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1ct53fz_di" bpmnElement="employeeCallCenter">
        <dc:Bounds x="234" y="297" width="978" height="430" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_17zriyl_di" bpmnElement="processStart">
        <dc:Bounds x="279" y="195" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="278" y="235" width="38" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0xtxt0y_di" bpmnElement="begin">
        <di:waypoint x="315" y="213" />
        <di:waypoint x="348" y="213" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="286.5" y="192" width="90" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="UserTask_0lu5e17_di" bpmnElement="cardCreation">
        <dc:Bounds x="348" y="173" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_0r7xv8d_di" bpmnElement="phoneCall">
        <dc:Bounds x="348" y="426" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1tacwa5_di" bpmnElement="callNeeded">
        <di:waypoint x="398" y="253" />
        <di:waypoint x="398" y="426" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="413" y="374" width="52" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_1cxly21_di" bpmnElement="recallDecision" isMarkerVisible="true">
        <dc:Bounds x="553" y="441" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="550" y="398" width="55" height="48" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1byphu1_di" bpmnElement="callResult">
        <di:waypoint x="448" y="466" />
        <di:waypoint x="553" y="466" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="455" y="470" width="87" height="24" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_1kdb8g9_di" bpmnElement="interest" isMarkerVisible="true">
        <dc:Bounds x="694" y="441" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="674" y="396" width="90" height="36" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1ja0018_di" bpmnElement="noRecallNeeded">
        <di:waypoint x="603" y="466" />
        <di:waypoint x="694" y="466" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="639" y="445" width="20" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1jtyyzx_di" bpmnElement="recallNeeded">
        <di:waypoint x="578" y="491" />
        <di:waypoint x="578" y="616" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="586" y="548" width="14" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="IntermediateCatchEvent_1s1lfau_di" bpmnElement="recallTimer">
        <dc:Bounds x="560" y="616" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="549.5" y="656" width="57" height="24" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0r6q30p_di" bpmnElement="recall">
        <di:waypoint x="560" y="634" />
        <di:waypoint x="398" y="634" />
        <di:waypoint x="398" y="506" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="458" y="613" width="66" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_1olpxbv_di" bpmnElement="targetDecision" isMarkerVisible="true">
        <dc:Bounds x="818" y="441" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="815" y="495" width="57" height="36" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_10iaarf_di" bpmnElement="interestNo">
        <di:waypoint x="744" y="466" />
        <di:waypoint x="818" y="466" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="784" y="445" width="20" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0nyz2lj_di" bpmnElement="targetedNo">
        <di:waypoint x="843" y="441" />
        <di:waypoint x="843" y="381" />
        <di:waypoint x="915" y="381" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="848" y="405" width="20" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0awwxca_di" bpmnElement="interestYes">
        <di:waypoint x="719" y="491" />
        <di:waypoint x="719" y="590" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="727" y="535" width="14" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="SendTask_0fksgti_di" bpmnElement="sendProposal">
        <dc:Bounds x="669" y="590" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0un5wop_di" bpmnElement="waining">
        <di:waypoint x="769" y="630" />
        <di:waypoint x="878" y="630" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="778.5" y="609" width="90" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="CallActivity_1wh2m21_di" bpmnElement="callNextProcess">
        <dc:Bounds x="991" y="173" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="IntermediateCatchEvent_1nb6dx1_di" bpmnElement="waitToApprove">
        <dc:Bounds x="878" y="612" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="863" y="652" width="81" height="60" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1vg8071_di" bpmnElement="end">
        <dc:Bounds x="1131" y="195" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1134" y="235" width="34" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0ogpfyl_di" bpmnElement="ending">
        <di:waypoint x="1091" y="213" />
        <di:waypoint x="1131" y="213" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1066" y="192" width="90" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1fkn1fh_di" bpmnElement="toProcessing">
        <di:waypoint x="914" y="630" />
        <di:waypoint x="1041" y="630" />
        <di:waypoint x="1041" y="253" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="932.5" y="609" width="90" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1hyje65_di" bpmnElement="targetedYes">
        <di:waypoint x="868" y="466" />
        <di:waypoint x="915" y="466" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="885" y="445" width="14" height="12" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="EndEvent_02qfwqk_di" bpmnElement="endToRepeat">
        <dc:Bounds x="915" y="448" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="901" y="488" width="67" height="36" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_13885u4_di" bpmnElement="endNotTargeted">
        <dc:Bounds x="915" y="363" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="899" y="403" width="69" height="24" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_0t5txpx_di" bpmnElement="incomingCall">
        <dc:Bounds x="813" y="195" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="787" y="235" width="90" height="24" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0du9snz_di" bpmnElement="callNetxStep">
        <di:waypoint x="849" y="213" />
        <di:waypoint x="991" y="213" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="885" y="183" width="66" height="24" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
